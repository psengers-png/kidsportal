<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Kleurplaat Generator</title>

    <style>
        body { font-family: Arial; background:#f9f9f9; margin:0; padding:0; }
        header { background:#4CAF50; color:white; padding:20px; text-align:center; }
        main { max-width:600px; margin:30px auto; padding:20px; background:white; border-radius:10px; }
        label { font-weight:bold; display:block; margin-bottom:5px; }
        input[type="text"], input[type="file"] { width:100%; padding:8px; margin-bottom:15px; }
        button { padding:10px 20px; background:#4CAF50; color:white; border:none; cursor:pointer; }
        button:hover { background:#45a049; }
    </style>
</head>

<body>

<header>
    <h1>Kleurplaat Generator</h1>
</header>

<main>

    <p id="statusText">Bezig met controleren...</p>
    <button id="logoutBtn" style="display:none;">Logout</button>

    <form id="kleurplaatForm" style="display:none;">
        <label>Wie?</label>
        <input id="wie" type="text">

        <label>Waar?</label>
        <input id="waar" type="text">

        <label>Welke activiteit?</label>
        <input id="activiteit" type="text">

        <label>Upload foto (optioneel)</label>
        <input id="foto" type="file">

        <button type="submit">Genereer kleurplaat</button>
    </form>

    <div id="resultaat"></div>

    <button id="downloadBtn" style="display:none;">Download</button>

    <!-- AGENT KNOP ðŸš€ -->
    <button id="agentBtn" style="display:none; margin-top:20px;">
        ðŸ¤– Open Kleurplaat Agent
    </button>

</main>

<!-- Scripts -->
<script src="https://alcdn.msauth.net/browser/2.32.0/js/msal-browser.min.js"></script>
<script src="/JS/auth.js"></script>

<script>
// Wacht tot auth.js klaar is en checkt inlogstatus
setTimeout(() => {
    const accounts = msalInstance.getAllAccounts();
    const statusText = document.getElementById("statusText");
    const form = document.getElementById("kleurplaatForm");
    const logoutBtn = document.getElementById("logoutBtn");
    
    if (accounts.length === 0) {
        // Niet ingelogd, terug naar home
        window.location.href = "/home.html";
        return;
    }
    
    // Wel ingelogd, toon form
    statusText.style.display = "none";
    form.style.display = "block";
    logoutBtn.style.display = "inline-block";
    
    // Logout functie
    logoutBtn.onclick = () => msalInstance.logoutRedirect();
}, 1000);

async function initFormLogic() {
    const fotoInput = document.getElementById("foto");
    const agentBtn = document.getElementById("agentBtn");
    const form = document.getElementById("kleurplaatForm");
    const resultaat = document.getElementById("resultaat");
    const downloadBtn = document.getElementById("downloadBtn");

    fotoInput.addEventListener("change", () => {
        const disabled = fotoInput.files.length > 0;
        document.getElementById("wie").disabled = disabled;
        document.getElementById("waar").disabled = disabled;
        document.getElementById("activiteit").disabled = disabled;
    });

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        resultaat.textContent = "Kleurplaat wordt aangemaakt...";
        agentBtn.style.display = "none";

        const wie = document.getElementById("wie").value;
        const waar = document.getElementById("waar").value;
        const activiteit = document.getElementById("activiteit").value;

        let foto_base64 = null;
        if (fotoInput.files.length > 0) {
            const file = fotoInput.files[0];
            foto_base64 = await new Promise((res, rej) => {
                const reader = new FileReader();
                reader.onload = () => res(reader.result);
                reader.onerror = () => rej('read-error');
                reader.readAsDataURL(file);
            });
        }

        const payload = { wie, waar, activiteit };
        if (foto_base64) payload.foto_base64 = foto_base64;

        try {
            const resp = await fetch('https://sengfam1.azurewebsites.net/api/kleurplaat_agent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const text = await resp.text();
            console.log("Response status:", resp.status);
            console.log("Response text:", text);
            
            if (!resp.ok) {
                resultaat.textContent = `Fout (${resp.status}): ${text}`;
                return;
            }
            
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                resultaat.textContent = `JSON parsing error: ${text}`;
                return;
            }

            const img = document.createElement('img');
            img.src = data.image_data_uri;
            img.style.maxWidth = '100%';
            resultaat.innerHTML = '';
            resultaat.appendChild(img);

            downloadBtn.style.display = 'inline-block';
            downloadBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = data.image_data_uri;
                a.download = 'kleurplaat.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };

        } catch (err) {
            resultaat.textContent = 'Fout: ' + err;
            console.error("Error:", err);
        }
    });
}

initFormLogic();
</script>

</body>
</html>